/**
 * äººè„¸æ³¨å†Œé¡µé¢
 */
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import HttpUtil from '../common/utils/HttpUtil'
import StorageUtil from '../common/utils/StorageUtil'
import CameraUtil from '../common/utils/CameraUtil'
import { ApiEndpoints, StorageKeys, AppConfig, ErrorMessages } from '../common/constants/AppConstants'

@Entry
@Component
struct FaceRegister {
  @State isLoading: boolean = false
  @State message: string = ''
  @State capturedImage: string = ''
  @State step: number = 1  // 1:è¯´æ˜Ž 2:æ‹ç…§ 3:ä¸Šä¼ 

  async aboutToAppear() {
    // åˆå§‹åŒ–ç›¸æœº
    await CameraUtil.init(getContext(this))
  }

  /**
   * æ‹ç…§
   */
  async handleTakePicture() {
    this.isLoading = true
    this.message = 'æ­£åœ¨å¯åŠ¨ç›¸æœº...'

    try {
      const photoBase64 = await CameraUtil.takePictureAsBase64()
      
      if (photoBase64) {
        this.capturedImage = photoBase64
        this.step = 3
        this.message = ''
        
        promptAction.showToast({
          message: 'ç…§ç‰‡æ‹æ‘„æˆåŠŸ',
          duration: 1500
        })
      } else {
        this.message = ErrorMessages.CAMERA_ERROR
        promptAction.showToast({
          message: ErrorMessages.CAMERA_ERROR,
          duration: 2000
        })
      }
    } catch (error) {
      console.error('[FaceRegister] Take picture error:', JSON.stringify(error))
      this.message = ErrorMessages.CAMERA_ERROR
      promptAction.showToast({
        message: ErrorMessages.CAMERA_ERROR,
        duration: 2000
      })
    } finally {
      this.isLoading = false
    }
  }

  /**
   * ä¸Šä¼ äººè„¸ç…§ç‰‡
   */
  async handleUpload() {
    if (!this.capturedImage) {
      promptAction.showToast({
        message: 'è¯·å…ˆæ‹ç…§',
        duration: 2000
      })
      return
    }

    this.isLoading = true
    this.message = 'æ­£åœ¨æ³¨å†Œäººè„¸...'

    try {
      const response: { success: boolean; error?: string } = await HttpUtil.uploadImage(
        ApiEndpoints.FACE_REGISTER,
        this.capturedImage,
        'photo'
      )

      if (response.success) {
        // æ›´æ–°æœ¬åœ°äººè„¸æ³¨å†ŒçŠ¶æ€
        await StorageUtil.setBoolean(StorageKeys.IS_FACE_REGISTERED, true)
        
        promptAction.showToast({
          message: 'äººè„¸æ³¨å†ŒæˆåŠŸ!',
          duration: 2000
        })

        // è·³è½¬åˆ°ä¸»é¡µ
        setTimeout(() => {
          router.replaceUrl({
            url: AppConfig.PAGE_HOME
          })
        }, 1500)
      } else {
        this.message = response.error || ErrorMessages.FACE_REGISTER_FAILED
        promptAction.showToast({
          message: response.error || ErrorMessages.FACE_REGISTER_FAILED,
          duration: 3000
        })
      }
    } catch (error) {
      console.error('[FaceRegister] Upload error:', JSON.stringify(error))
      this.message = ErrorMessages.NETWORK_ERROR
      promptAction.showToast({
        message: ErrorMessages.NETWORK_ERROR,
        duration: 3000
      })
    } finally {
      this.isLoading = false
    }
  }

  /**
   * é‡æ–°æ‹ç…§
   */
  handleRetake() {
    this.capturedImage = ''
    this.step = 2
    this.message = ''
  }

  /**
   * è·³è¿‡æ³¨å†Œ
   */
  handleSkip() {
    router.replaceUrl({
      url: AppConfig.PAGE_HOME
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Row() {
        Text('äººè„¸æ³¨å†Œ')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Center)

      // ä¸»å†…å®¹åŒºåŸŸ
      Column() {
        if (this.step === 1) {
          // è¯´æ˜Žé¡µé¢
          Column() {
            Image($r('app.media.face_guide'))
              .width(200)
              .height(200)
              .margin({ bottom: 30 })

            Text('é¦–æ¬¡ä½¿ç”¨éœ€è¦æ³¨å†Œäººè„¸')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ bottom: 15 })

            Column() {
              Text('â€¢ è¯·ç¡®ä¿å…‰çº¿å……è¶³')
                .fontSize(16)
                .fontColor('#666')
                .margin({ bottom: 8 })

              Text('â€¢ æ­£å¯¹æ‘„åƒå¤´,ä¿æŒé¢éƒ¨æ¸…æ™°')
                .fontSize(16)
                .fontColor('#666')
                .margin({ bottom: 8 })

              Text('â€¢ æ‘˜ä¸‹çœ¼é•œå’Œå£ç½©')
                .fontSize(16)
                .fontColor('#666')
                .margin({ bottom: 8 })

              Text('â€¢ ä¿æŒè‡ªç„¶è¡¨æƒ…')
                .fontSize(16)
                .fontColor('#666')
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 40 })

            Button('å¼€å§‹æ‹ç…§')
              .width('80%')
              .height(50)
              .fontSize(18)
              .fontColor('#FFFFFF')
              .backgroundColor('#007DFF')
              .borderRadius(10)
              .onClick(() => {
                this.step = 2
                this.handleTakePicture()
              })

            Button('ç¨åŽæ³¨å†Œ')
              .width('80%')
              .height(50)
              .fontSize(16)
              .fontColor('#666')
              .backgroundColor('#FFFFFF')
              .border({ width: 1, color: '#DDDDDD' })
              .borderRadius(10)
              .margin({ top: 15 })
              .onClick(() => {
                this.handleSkip()
              })
          }
          .width('100%')
          .padding(30)

        } else if (this.step === 2) {
          // æ‹ç…§ä¸­
          Column() {
            Text('è¯·æ­£å¯¹æ‘„åƒå¤´')
              .fontSize(18)
              .fontColor('#333')
              .margin({ top: 50, bottom: 30 })

            // ç›¸æœºé¢„è§ˆåŒºåŸŸå ä½
            Column() {
              Text('ðŸ“·')
                .fontSize(80)
            }
            .width(300)
            .height(400)
            .backgroundColor('#000000')
            .borderRadius(15)
            .justifyContent(FlexAlign.Center)

            if (this.isLoading) {
              Text(this.message || 'å‡†å¤‡ä¸­...')
                .fontSize(16)
                .fontColor('#666')
                .margin({ top: 20 })
            }
          }
          .width('100%')

        } else if (this.step === 3) {
          // ç…§ç‰‡é¢„è§ˆå’Œä¸Šä¼ 
          Column() {
            Text('ç…§ç‰‡é¢„è§ˆ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ top: 20, bottom: 20 })

            // æ˜¾ç¤ºæ‹æ‘„çš„ç…§ç‰‡
            Image(`data:image/jpeg;base64,${this.capturedImage}`)
              .width(300)
              .height(400)
              .objectFit(ImageFit.Cover)
              .borderRadius(15)
              .margin({ bottom: 30 })

            Row() {
              Button('é‡æ–°æ‹ç…§')
                .width('45%')
                .height(50)
                .fontSize(16)
                .fontColor('#666')
                .backgroundColor('#FFFFFF')
                .border({ width: 1, color: '#DDDDDD' })
                .borderRadius(10)
                .enabled(!this.isLoading)
                .onClick(() => {
                  this.handleRetake()
                })

              Button(this.isLoading ? 'ä¸Šä¼ ä¸­...' : 'ç¡®è®¤ä¸Šä¼ ')
                .width('45%')
                .height(50)
                .fontSize(16)
                .fontColor('#FFFFFF')
                .backgroundColor(this.isLoading ? '#CCCCCC' : '#007DFF')
                .borderRadius(10)
                .enabled(!this.isLoading)
                .onClick(() => {
                  this.handleUpload()
                })
            }
            .width('85%')
            .justifyContent(FlexAlign.SpaceBetween)

            if (this.message) {
              Text(this.message)
                .fontSize(14)
                .fontColor('#FF0000')
                .margin({ top: 15 })
            }
          }
          .width('100%')
        }
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }
}