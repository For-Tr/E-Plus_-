/**
 * æ‰“å¡é¡µé¢
 */
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'
import HttpUtil from '../common/utils/HttpUtil'
import CameraUtil from '../common/utils/CameraUtil'
import { ApiEndpoints, EMOTION_NAMES, ErrorMessages } from '../common/constants/AppConstants'
import { CheckinTaskListResponse } from '../models/CheckinTask'
import { CheckinCreateRequest, CheckinRecord } from '../models/CheckinRecord'

@Entry
@Component
struct Checkin {
  @State isLoading: boolean = false
  @State message: string = ''
  @State currentTask: any = null
  @State capturedImage: string = ''
  @State checkinResult: CheckinRecord | null = null
  @State step: number = 1  // 1:ä»»åŠ¡è¯´æ˜ 2:æ‹ç…§ 3:ç»“æœå±•ç¤º

  async aboutToAppear() {
    await CameraUtil.init(getContext(this))
    await this.loadTask()
  }

  /**
   * åŠ è½½æ‰“å¡ä»»åŠ¡
   */
  async loadTask() {
    this.isLoading = true

    try {
      const response = await HttpUtil.get<CheckinTaskListResponse>(ApiEndpoints.CHECKIN_TASKS)
      
      if (response.success && response.data && response.data.results.length > 0) {
        // è·å–ç¬¬ä¸€ä¸ªæ´»è·ƒä»»åŠ¡
        this.currentTask = response.data.results[0]
        console.info('[Checkin] Task loaded:', JSON.stringify(this.currentTask))
      } else {
        promptAction.showToast({
          message: 'æš‚æ— æ‰“å¡ä»»åŠ¡',
          duration: 2000
        })
        setTimeout(() => {
          router.back()
        }, 1500)
      }
    } catch (error) {
      console.error('[Checkin] Load task error:', JSON.stringify(error))
      promptAction.showToast({
        message: ErrorMessages.NETWORK_ERROR,
        duration: 2000
      })
    } finally {
      this.isLoading = false
    }
  }

  /**
   * å¼€å§‹æ‹ç…§
   */
  async handleStartCapture() {
    this.step = 2
    this.isLoading = true
    this.message = 'æ­£åœ¨å¯åŠ¨ç›¸æœº...'

    try {
      const photoBase64 = await CameraUtil.takePictureAsBase64()
      
      if (photoBase64) {
        this.capturedImage = photoBase64
        this.message = ''
        
        // ç›´æ¥æäº¤æ‰“å¡
        await this.submitCheckin()
      } else {
        this.message = ErrorMessages.CAMERA_ERROR
        promptAction.showToast({
          message: ErrorMessages.CAMERA_ERROR,
          duration: 2000
        })
        this.step = 1
      }
    } catch (error) {
      console.error('[Checkin] Capture error:', JSON.stringify(error))
      this.message = ErrorMessages.CAMERA_ERROR
      this.step = 1
    } finally {
      this.isLoading = false
    }
  }

  /**
   * æäº¤æ‰“å¡
   */
  async submitCheckin() {
    this.isLoading = true
    this.message = 'æ­£åœ¨è¯†åˆ«äººè„¸å’Œæƒ…ç»ª...'

    try {
      const requestData: CheckinCreateRequest = {
        task_id: this.currentTask.id,
        photo: this.capturedImage
      }

      const response = await HttpUtil.post<CheckinRecord>(
        ApiEndpoints.CHECKIN_CREATE,
        requestData
      )

      if (response.success && response.data) {
        this.checkinResult = response.data
        this.step = 3
        this.message = ''
        
        promptAction.showToast({
          message: 'æ‰“å¡æˆåŠŸ!',
          duration: 2000
        })
      } else {
        this.message = response.error || ErrorMessages.CHECKIN_FAILED
        this.step = 1
        promptAction.showToast({
          message: response.error || ErrorMessages.CHECKIN_FAILED,
          duration: 3000
        })
      }
    } catch (error) {
      console.error('[Checkin] Submit error:', JSON.stringify(error))
      this.message = ErrorMessages.NETWORK_ERROR
      this.step = 1
      promptAction.showToast({
        message: ErrorMessages.NETWORK_ERROR,
        duration: 3000
      })
    } finally {
      this.isLoading = false
    }
  }

  /**
   * å®Œæˆæ‰“å¡,è¿”å›ä¸»é¡µ
   */
  handleFinish() {
    router.back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back()
          })

        Text('æ‰“å¡')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½,ä¿æŒæ ‡é¢˜å±…ä¸­
        Column()
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })
      .backgroundColor('#FFFFFF')

      // ä¸»å†…å®¹
      Column() {
        if (this.step === 1 && this.currentTask) {
          // ä»»åŠ¡è¯´æ˜é¡µé¢
          Column() {
            Image($r('app.media.checkin_icon'))
              .width(100)
              .height(100)
              .margin({ top: 50, bottom: 30 })

            Text(this.currentTask.task_name)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 15 })

            Column() {
              Text('å‡†å¤‡å¼€å§‹æ‰“å¡')
                .fontSize(18)
                .fontColor('#666')
                .margin({ bottom: 20 })

              Column() {
                Text('â€¢ è¯·æ­£å¯¹æ‘„åƒå¤´')
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ bottom: 8 })

                Text('â€¢ ä¿æŒé¢éƒ¨æ¸…æ™°å¯è§')
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ bottom: 8 })

                Text('â€¢ ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ‚¨çš„æƒ…ç»ª')
                  .fontSize(16)
                  .fontColor('#666')
                  .margin({ bottom: 8 })
              }
              .alignItems(HorizontalAlign.Start)
              .padding(20)
              .backgroundColor('#FFF9E6')
              .borderRadius(10)
            }
            .width('85%')
            .margin({ bottom: 50 })

            Button('å¼€å§‹æ‰“å¡')
              .width('70%')
              .height(55)
              .fontSize(20)
              .fontColor('#FFFFFF')
              .backgroundColor('#007DFF')
              .borderRadius(15)
              .enabled(!this.isLoading)
              .onClick(() => {
                this.handleStartCapture()
              })
          }
          .width('100%')

        } else if (this.step === 2) {
          // æ‹ç…§ä¸­
          Column() {
            Text('è¯·ä¿æŒé¢éƒ¨åœ¨æ¡†å†…')
              .fontSize(18)
              .fontColor('#333')
              .margin({ top: 50, bottom: 30 })

            // ç›¸æœºé¢„è§ˆå ä½
            Column() {
              Text('ğŸ“·')
                .fontSize(80)
            }
            .width(300)
            .height(400)
            .backgroundColor('#000000')
            .borderRadius(15)
            .justifyContent(FlexAlign.Center)

            Text(this.message)
              .fontSize(16)
              .fontColor('#666')
              .margin({ top: 20 })
          }

        } else if (this.step === 3 && this.checkinResult) {
          // ç»“æœå±•ç¤º
          Column() {
            // æˆåŠŸå›¾æ ‡
            Text('âœ“')
              .fontSize(80)
              .fontColor('#52C41A')
              .margin({ top: 50, bottom: 20 })

            Text('æ‰“å¡æˆåŠŸ!')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .margin({ bottom: 40 })

            // ç»“æœå¡ç‰‡
            Column() {
              // æ‰“å¡æ—¶é—´
              Row() {
                Text('æ‰“å¡æ—¶é—´:')
                  .fontSize(16)
                  .fontColor('#666')
                Blank()
                Text(new Date(this.checkinResult.checkin_time).toLocaleString('zh-CN'))
                  .fontSize(16)
                  .fontColor('#333')
              }
              .width('100%')
              .margin({ bottom: 15 })

              // æ‰“å¡çŠ¶æ€
              Row() {
                Text('æ‰“å¡çŠ¶æ€:')
                  .fontSize(16)
                  .fontColor('#666')
                Blank()
                Text(
                  this.checkinResult.status === 'on_time' ? 'å‡†æ—¶' :
                  this.checkinResult.status === 'late' ? 'è¿Ÿåˆ°' : 'è¡¥ç­¾'
                )
                  .fontSize(16)
                  .fontColor(
                    this.checkinResult.status === 'on_time' ? '#52C41A' :
                    this.checkinResult.status === 'late' ? '#FAAD14' : '#F5222D'
                  )
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .margin({ bottom: 15 })

              // è¯†åˆ«æƒ…ç»ª
              if (this.checkinResult.emotion) {
                Row() {
                  Text('å½“å‰æƒ…ç»ª:')
                    .fontSize(16)
                    .fontColor('#666')
                  Blank()
                  Text(EMOTION_NAMES[this.checkinResult.emotion] || this.checkinResult.emotion)
                    .fontSize(20)
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .margin({ bottom: 15 })
              }

              // ç½®ä¿¡åº¦
              if (this.checkinResult.emotion_confidence) {
                Row() {
                  Text('ç½®ä¿¡åº¦:')
                    .fontSize(16)
                    .fontColor('#666')
                  Blank()
                  Text(`${this.checkinResult.emotion_confidence.toFixed(1)}%`)
                    .fontSize(16)
                    .fontColor('#333')
                }
                .width('100%')
              }
            }
            .width('85%')
            .padding(25)
            .backgroundColor('#FFFFFF')
            .borderRadius(15)
            .shadow({
              radius: 15,
              color: '#00000010',
              offsetX: 0,
              offsetY: 3
            })
            .margin({ bottom: 50 })

            Button('å®Œæˆ')
              .width('70%')
              .height(50)
              .fontSize(18)
              .fontColor('#FFFFFF')
              .backgroundColor('#007DFF')
              .borderRadius(10)
              .onClick(() => {
                this.handleFinish()
              })
          }
          .width('100%')
        }
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }
}